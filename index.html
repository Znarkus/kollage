<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<!--<meta name="viewport" content="width=device-width, initial-scale=1">-->
	<title>Kollage</title>

	<!-- Bootstrap -->
	<link href="bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="stylesheets/style.css" rel="stylesheet">

	<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
	<!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->
</head>
<body>


<div class="container-fluid">

	<input id="width" value="1280">
	x
	<input id="height" value="600">

	<input type="file" multiple id="file">

	<canvas id="canvas"></canvas>
	<!--


	style="width: 800px; height: 600px;"


	-->

</div>



<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

<script>

	var $file,
		canvas,
		ctx,
		images;

	$file = $('#file');
	$file.change(handleImage);

	canvas = $('#canvas')[0];
	updateCanvasSize();

	$('#width, #height').change(function () {
		updateCanvasSize();
		images.draw();
	});

	ctx = canvas.getContext('2d');
//	ctx.scale(1 / window.devicePixelRatio, 1 / window.devicePixelRatio);

//
//	ctx.imageSmoothingEnabled = true;
//	ctx.webkitImageSmoothingEnabled = true;
//	ctx.mozImageSmoothingEnabled = true;





	function handleImage(e){
		var reader = new FileReader(),
				index = 0;

		images = new KollageImages();

		reader.onload = function(event){
			images.add(event.target.result);

			nextFile();
		};

		nextFile();

		function nextFile() {
			if (index < e.target.files.length) {
				reader.readAsDataURL(e.target.files[index]);
				index += 1;
			} else {
				setTimeout(images.draw, 10);
			}
		}

	}

	function updateCanvasSize() {
		canvas.width = $('#width').val();
		canvas.height = $('#height').val();
	}

	function KollageImages() {
		var images = [];
//		var lastImageLoaded;

		this.add = function (url) {
			var img = new KollageImage(url, function () {
				clearCanvas();
				img.draw(0, 0, null, canvas.height);
				images.push(img);
			});
		};

		this.draw = function () {
			var x, y;

			clearCanvas();
			
			$.each(images, function (i, img) {
				var lastImg = i > 0 ? images[i - 1] : null;

				if (lastImg) {
					x = lastImg.x() + lastImg.width();
					y = lastImg.y();

					if (x > canvas.width) {
						x = 0;
						y += lastImg.height();
					}

				} else {
					x = 0;
					y = 0;
				}

				img.draw(
					x,
					y,
					null,
					canvas.height / 2
				);
			});

			


		};

		function clearCanvas() {
			// Store the current transformation matrix
			ctx.save();

			// Use the identity matrix while clearing the canvas
			ctx.setTransform(1, 0, 0, 1, 0, 0);
			ctx.clearRect(0, 0, canvas.width, canvas.height);

			// Restore the transform
			ctx.restore();
		}
	}

	function KollageImage(url, loadedCallback) {
		var img = new Image();
		var _x = 0;
		var _y = 0;
		var _width = 0;
		var _height = 0;
		var _aspect;

		img.onload = function () {
			_aspect = img.width / img.height;
			loadedCallback();
		};

		img.src = url;

		this.draw = function (x, y, width, height) {
			_x = x;
			_y = y;

			if (!width && height) {
				width = height * _aspect;
			}

			if (!height && width) {
				height = width / _aspect;
			}

			if (!width && !height) {
				width = img.width;
				height = img.height;
			}

			_width = width;
			_height = height;
//			ctx.drawImage(img, x, y);
			ctx.drawImage(img, x, y, _width, _height);
		}

		this.x = function () {
			return _x;
		}

		this.y = function () {
			return _y;
		}

		this.width = function () {
			return _width;
		}

		this.height = function () {
			return _height;
		}
	}


</script>

</body>
</html>